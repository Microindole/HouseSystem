<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai.css') }}">
    <script src="{{ url_for('static', filename='js/sidebar.js') }}" defer></script>

    <!-- AIèŠå¤©æ‰€éœ€çš„ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js" defer></script>

    {% block head %}
    {% endblock %}
    <title>{% block title %}æ™ºèƒ½æˆ¿å±‹ç§Ÿèµç³»ç»Ÿ{% endblock %}</title>

</head>

<body>
<div class="navbar animated-navbar" style="background-image: url('{{ url_for('static', filename='images/background-pattern.png') }}'); background-size: cover; background-repeat: no-repeat; background-position: center; background-color: #222; padding: 35px 40px; color: #fff; display: flex; align-items: center; justify-content: space-between; border-radius: 2px;">
    <div style="display: flex; align-items: center; gap: 20px;">

        <a href="{{ url_for('house.house_list') }}" class="house-link">ä¹å±…é˜</a>
        <form style="display: flex; gap: 12px; align-items: center;">
            <select name="region" id="provinceSelect" onchange="updateCities();" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: rgba(255, 255, 255, 0.8); color: #333; outline: none; font-size: 1rem;">
                <option value="">é€‰æ‹©çœä»½</option>
                {% for province in cities_data.keys() %}
                    <option value="{{ province }}" {% if province == selected_region %}selected{% endif %}>{{ province }}</option>
                {% endfor %}
            </select>
            <select name="city" id="citySelect" onchange="this.form.submit();" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: rgba(255, 255, 255, 0.8); color: #333; outline: none; font-size: 1rem;">
                <option value="">é€‰æ‹©åŸå¸‚</option>
                {% if selected_region %}
                    {% for city in cities_data[selected_region] %}
                        <option value="{{ city }}" {% if city == selected_city %}selected="selected"{% endif %}>{{ city }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </form>
    </div>
    <div style="display: flex; align-items: center; justify-content: center; width: 100%;">
        <form method="get" action="{{ url_for('house.house_list') }}" style="display: flex; align-items: center; gap: 10px; width: 100%; max-width: 600px;">
            <input type="text" name="keyword" placeholder="æœç´¢æˆ¿æº" value="{{ filters.keyword if filters else '' }}" style="flex: 1; padding: 12px 16px; border-radius: 6px; border: 1px solid #ccc; background-color: rgba(255, 255, 255, 0.8); color: #333; outline: none; font-size: 1rem;">
            <button type="submit" class="git-search-button" style="padding: 12px 20px; background-color: #28a745; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">æœç´¢</button>
        </form>
    </div>
    <div style="display: flex; align-items: center; gap: 20px;">
        {% if g.username %}
            <button id="user-menu-button" class="username-button">{{ g.username }}</button>
        {% else %}
            <a href="{{ url_for('account.login') }}" class="login-button">ç™»å½•</a>
        {% endif %}
    </div>
</div>
<div id="user-sidebar" class="user-sidebar hidden">
    <div class="user-sidebar-header">
        <h2>{{ g.username }}</h2>
        <button id="close-sidebar" class="close-button">&times;</button>
    </div>
    <ul class="user-sidebar-menu">
        <!-- ...existing menu code... -->
        <!-- å…¬å…±èœå•é¡¹ -->
        <li>
            <a href="{% if g.user_type == 1 %}{{ url_for('account.tenant_home') }}{% elif g.user_type == 2 %}{{ url_for('account.landlord_home') }}{% else %}{{ url_for('account.admin_dashboard') }}{% endif %}">
                ğŸ  æˆ‘çš„ä¸»é¡µ
            </a>
        </li>
        <li><a href="{{ url_for('account.profile') }}">ğŸ‘¤ ä¸ªäººä¿¡æ¯</a></li>
        <li>
            <a href="{{ url_for('feedback.messages') }}">
                ğŸ’¬ æˆ‘çš„æ¶ˆæ¯
                {% if unread_total and unread_total > 0 %}
                    <span class="unread-badge" style="background:#f56c6c;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:6px;">
                    {{ unread_total }}
                </span>
                {% endif %}
            </a>
        </li>
        {% if g.user_type == 1 %}
            <!-- ç§Ÿå®¢ä¸“ç”¨èœå• -->
            <li><a href="{{ url_for('house.house_list') }}">ğŸ” æµè§ˆæˆ¿æº</a></li>
            <li><a href="{{ url_for('house.browse_history') }}">ğŸ“– æµè§ˆå†å²</a></li>
            <li><a href="{{ url_for('house.popular_houses') }}">ğŸ”¥ çƒ­é—¨æˆ¿æº</a></li>
            <li><a href="{{ url_for('contract.view_contracts') }}">ğŸ“„ ç§ŸèµåˆåŒ</a></li>
            <li><a href="{{ url_for('house.view_appointments') }}">ğŸ“… æˆ‘çš„é¢„çº¦</a></li>
            <li><a href="{{ url_for('house.manage_repair_requests') }}">ğŸ”§ ç»´ä¿®è¯·æ±‚</a></li>
            <li>
            <a href="{{ url_for('feedback.complaint') }}">
                ğŸ“¢ æŠ•è¯‰åé¦ˆ
                {% if unread_complaint_updates and unread_complaint_updates > 0 %}
                    <span class="unread-badge" style="background:#ff9800;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:6px;">
                    {{ unread_complaint_updates }}
                </span>
                {% endif %}
            </a>
        </li>
        {% elif g.user_type == 2 %}
            <!-- æˆ¿ä¸œä¸“ç”¨èœå• -->
            <li><a href="{{ url_for('house.add_house') }}">â• å‘å¸ƒæˆ¿æº</a></li>
            <li><a href="{{ url_for('house.add_news') }}">ğŸ“° å‘å¸ƒæ–°é—»</a></li>
            <li><a href="{{ url_for('house.manage_news') }}">ğŸ“ ç®¡ç†æ–°é—»</a></li>
            <li><a href="{{ url_for('contract.view_contracts') }}">ğŸ“„ ç§ŸèµåˆåŒ</a></li>
            <li><a href="{{ url_for('house.view_appointments') }}">ğŸ“… é¢„çº¦ç®¡ç†</a></li>
            <li><a href="{{ url_for('house.manage_repair_requests') }}">ğŸ”§ ç»´ä¿®ç®¡ç†</a></li>
            <li>
            <a href="{{ url_for('feedback.complaint') }}">
                ğŸ“¢ æŠ•è¯‰åé¦ˆ
                {% if unread_complaint_updates and unread_complaint_updates > 0 %}
                    <span class="unread-badge" style="background:#ff9800;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:6px;">
                    {{ unread_complaint_updates }}
                </span>
                {% endif %}
            </a>
        </li>
        {% elif g.user_type == 0 %}
            <!-- ç®¡ç†å‘˜ä¸“ç”¨èœå• -->
            <li><a href="{{ url_for('account.manage_users') }}">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a></li>
            <li><a href="{{ url_for('account.audit_list') }}">âœ… æˆ¿æºå®¡æ ¸</a></li>
            <li><a href="/account/admin/system_setting">âš™ï¸ ç³»ç»Ÿè®¾ç½®</a></li>
            <li><a href="{{ url_for('feedback.manage_complaints') }}">âš–ï¸ æŠ•è¯‰ç®¡ç†</a></li>
        {% endif %}
        <!-- å…¬å…±åº•éƒ¨èœå• -->

        <li><a href="{{ url_for('account.logout') }}">ğŸšª é€€å‡ºç™»å½•</a></li>
    </ul>
</div>

<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -  å­æ¨¡æ¿å†…å®¹ä¼šæ¸²æŸ“åˆ°è¿™é‡Œ -->
<div class="container">
    {% block body %}{% endblock %}
</div>

<!-- AIèŠå¤©åŠŸèƒ½ - åªæœ‰ç™»å½•ç”¨æˆ·æ‰æ˜¾ç¤º -->
{% if g.username %}
    <!-- AIèŠå¤©å›¾æ ‡ -->
    <div id="ai-chat-icon-container">
        <img src="https://house-system.oss-cn-shenzhen.aliyuncs.com/house_images/house_deepseek.png" alt="AI Chat">
    </div>

    <!-- AIèŠå¤©çª—å£ -->
    <div id="ai-chat-window" class="hidden">
        <div id="ai-chat-header">
            <h3>AI èŠå¤©åŠ©æ‰‹</h3>
            <div class="ai-chat-header-buttons">
                <button id="ai-chat-analyze-page" title="åˆ†æå½“å‰é¡µé¢">ğŸ“„</button>
                <button id="ai-chat-clear-history" title="æ¸…é™¤èŠå¤©è®°å½•">ğŸ—‘ï¸</button>
                <button id="ai-chat-close-button" title="å…³é—­çª—å£">&times;</button>
            </div>
        </div>
        <div id="ai-chat-messages-container">
            <!-- èŠå¤©æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
        <div id="ai-chat-typing-indicator" class="ai-chat-typing-indicator" style="display: none;">
            AI æ­£åœ¨æ€è€ƒ...
        </div>
        <div id="ai-chat-input-area">
            <textarea id="ai-chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enter æ¢è¡Œï¼ŒCtrl+Alt+H åˆ‡æ¢çª—å£)" rows="2"></textarea>
            <button id="ai-chat-send-button">å‘é€</button>
        </div>
        <!-- è°ƒæ•´å¤§å°çš„æ‰‹æŸ„ä¼šç”±JavaScriptåŠ¨æ€åˆ›å»º -->
    </div>
{% endif %}

<!-- é¡µè„š -->
<div class="footer animated-footer">
    <p>Â© 2025 æ™ºèƒ½æˆ¿å±‹ç§Ÿèµç³»ç»Ÿ. æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ ä¸æ¼”ç¤ºç›®çš„.</p>
</div>
<script src="{{ url_for('static', filename='js/common/message-toast.js') }}"></script>
<!-- åªæœ‰ç™»å½•ç”¨æˆ·æ‰åŠ è½½AIèŠå¤©ç›¸å…³çš„JavaScript -->
{% if g.username %}
    <script src="{{ url_for('static', filename='js/ai.js') }}" defer></script>
{% endif %}
<script>
    // çœä»½é€‰æ‹©å˜åŒ–æ—¶ï¼ŒåŠ¨æ€æ›´æ–°åŸå¸‚é€‰æ‹©æ¡†
    function updateCities() {
        var provinceSelect = document.getElementById('provinceSelect');
        if (!provinceSelect) return; // Guard clause
        var province = provinceSelect.value;
        var cities_data_json = JSON.parse('{{ cities_data | tojson | safe }}'); // Use safe filter
        var citySelect = document.getElementById('citySelect');
        var selectedCityFromServer = "{{ selected_city }}";

        citySelect.innerHTML = '<option value="">é€‰æ‹©åŸå¸‚</option>';

        if (province && cities_data_json[province]) {
            cities_data_json[province].forEach(function(city) {
                var option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === selectedCityFromServer) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });
        }
    }

    // åˆå§‹åŠ è½½æ—¶ï¼Œæ›´æ–°åŸå¸‚ä¸‹æ‹‰æ¡†
    window.addEventListener('load', function() {
        updateCities();
        // Ensure region-button related script is also robust
        const regionButton = document.getElementById('region-button');
        if (regionButton) {
            regionButton.addEventListener('click', function() {
                const dropdown = document.getElementById('region-dropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            });
        }
    });
</script>
</body>

</html>


