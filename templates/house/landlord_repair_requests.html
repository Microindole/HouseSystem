{% extends 'base.html' %}
{% block title %}ç»´ä¿®è¯·æ±‚ç®¡ç†{% endblock %}
{% block head %}
<style>
.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    margin-bottom: 30px;
}

.header-section h1 {
    color: #333;
    margin-bottom: 10px;
}

.btn {
    background: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    margin: 0 5px;
}

.btn:hover {
    opacity: 0.9;
    text-decoration: none;
    color: white;
}

.btn-success {
    background: #28a745;
}

.btn-danger {
    background: #dc3545;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-secondary {
    background: #6c757d;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 12px;
    margin: 2px;
}

.stats-section {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.stat-label {
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}

.request-list {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.request-item {
    border-bottom: 1px solid #eee;
    padding: 20px;
}

.request-item:last-child {
    border-bottom: none;
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.house-name {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-approved {
    background: #d4edda;
    color: #155724;
}

.status-processing {
    background: #d1ecf1;
    color: #0c5460;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.request-meta {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
}

.request-content {
    color: #333;
    line-height: 1.6;
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.action-section {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-top: 15px;
}

.action-buttons {
    margin-bottom: 15px;
}

.notes-form {
    display: none;
    margin-top: 15px;
}

.notes-form textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
    resize: vertical;
}

.notes-form .form-actions {
    margin-top: 10px;
}

.handler-notes {
    margin-top: 15px;
    padding: 15px;
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    border-radius: 4px;
}

.handler-notes h5 {
    margin: 0 0 10px 0;
    color: #007bff;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state h3 {
    margin-bottom: 15px;
    color: #999;
}

.empty-state .icon {
    font-size: 48px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .stats-section {
        flex-direction: column;
    }
    
    .request-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .request-meta {
        flex-direction: column;
        gap: 5px;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
}
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="header-section">
        <h1>ç»´ä¿®è¯·æ±‚ç®¡ç†</h1>
        <a href="{{ url_for('account.landlord_home') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
    </div>
    
    {% if requests %}
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'è¯·æ±‚ä¸­')|list|count }}</div>
            <div class="stat-label">å¾…å¤„ç†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'å¤„ç†ä¸­')|list|count }}</div>
            <div class="stat-label">å¤„ç†ä¸­</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ requests|selectattr('status', 'equalto', 'å·²å®Œæˆ')|list|count }}</div>
            <div class="stat-label">å·²å®Œæˆ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ requests|count }}</div>
            <div class="stat-label">æ€»è®¡</div>
        </div>
    </div>
    
    <div class="request-list">
        {% for request in requests %}
        <div class="request-item">
            <div class="request-header">
                <span class="house-name">
                    {% if request.house %}
                        {{ request.house.house_name }}
                    {% else %}
                        æˆ¿æºID: {{ request.house_id }}
                    {% endif %}
                </span>
                <span class="status-badge status-{{ request.status.replace('è¯·æ±‚ä¸­', 'pending').replace('å·²åŒæ„', 'approved').replace('å¤„ç†ä¸­', 'processing').replace('å·²å®Œæˆ', 'completed').replace('å·²æ‹’ç»', 'rejected') }}">
                    {{ request.status }}
                </span>
            </div>
            
            <div class="request-meta">
                <span>ç§Ÿå®¢ï¼š{{ request.tenant_username }}</span>
                <span>ç”³è¯·æ—¶é—´ï¼š{{ request.request_time.strftime('%Y-%m-%d %H:%M') if request.request_time else 'æœªçŸ¥' }}</span>
                {% if request.handled_time %}
                <span>å¤„ç†æ—¶é—´ï¼š{{ request.handled_time.strftime('%Y-%m-%d %H:%M') }}</span>
                {% endif %}
            </div>
            
            <div class="request-content">
                <strong>ç»´ä¿®å†…å®¹ï¼š</strong><br>
                {{ request.content }}
            </div>
            
            {% if request.status == 'è¯·æ±‚ä¸­' %}
            <div class="action-section">
                <div class="action-buttons">
                    <button class="btn btn-success btn-sm" onclick="showNotesForm({{ request.id }}, 'å·²åŒæ„')">åŒæ„</button>
                    <button class="btn btn-warning btn-sm" onclick="handleRequest({{ request.id }}, 'å¤„ç†ä¸­')">å¼€å§‹å¤„ç†</button>
                    <button class="btn btn-danger btn-sm" onclick="showNotesForm({{ request.id }}, 'å·²æ‹’ç»')">æ‹’ç»</button>
                </div>
                
                <div id="notes-form-{{ request.id }}" class="notes-form">
                    <textarea id="notes-{{ request.id }}" placeholder="è¯·å¡«å†™å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                    <div class="form-actions">
                        <button class="btn btn-success btn-sm" onclick="handleRequestWithNotes({{ request.id }})">ç¡®è®¤</button>
                        <button class="btn btn-secondary btn-sm" onclick="hideNotesForm({{ request.id }})">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            {% elif request.status == 'å¤„ç†ä¸­' %}
            <div class="action-section">
                <div class="action-buttons">
                    <button class="btn btn-success btn-sm" onclick="showNotesForm({{ request.id }}, 'å·²å®Œæˆ')">æ ‡è®°å®Œæˆ</button>
                </div>
                
                <div id="notes-form-{{ request.id }}" class="notes-form">
                    <textarea id="notes-{{ request.id }}" placeholder="è¯·å¡«å†™å®Œæˆæƒ…å†µè¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
                    <div class="form-actions">
                        <button class="btn btn-success btn-sm" onclick="handleRequestWithNotes({{ request.id }})">ç¡®è®¤å®Œæˆ</button>
                        <button class="btn btn-secondary btn-sm" onclick="hideNotesForm({{ request.id }})">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if request.handler_notes %}
            <div class="handler-notes">
                <h5>å¤„ç†å¤‡æ³¨ï¼š</h5>
                {{ request.handler_notes }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="icon">ğŸ”§</div>
        <h3>æš‚æ— ç»´ä¿®è¯·æ±‚</h3>
        <p>ç›®å‰æ²¡æœ‰æ”¶åˆ°ä»»ä½•ç»´ä¿®è¯·æ±‚</p>
    </div>
    {% endif %}
</div>

<script>
let currentRequestId = null;
let currentStatus = null;

function showNotesForm(requestId, status) {
    currentRequestId = requestId;
    currentStatus = status;
    
    // éšè—æ‰€æœ‰è¡¨å•
    document.querySelectorAll('.notes-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // æ˜¾ç¤ºå½“å‰è¡¨å•
    const form = document.getElementById(`notes-form-${requestId}`);
    if (form) {
        form.style.display = 'block';
    }
}

function hideNotesForm(requestId) {
    const form = document.getElementById(`notes-form-${requestId}`);
    if (form) {
        form.style.display = 'none';
    }
    currentRequestId = null;
    currentStatus = null;
}

function handleRequest(requestId, status) {
    handleRequestWithNotes(requestId, status, '');
}

function handleRequestWithNotes(requestId, status = null, notes = null) {
    const finalStatus = status || currentStatus;
    const finalNotes = notes !== null ? notes : (document.getElementById(`notes-${currentRequestId || requestId}`)?.value || '');
    
    fetch(`/house/repair/handle/${currentRequestId || requestId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: finalStatus,
            notes: finalNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('å¤„ç†å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'r':
                e.preventDefault();
                location.reload();
                break;
        }
    }
});

// è‡ªåŠ¨åˆ·æ–°ï¼ˆå¯é€‰ï¼‰
function autoRefresh() {
    const pendingCount = {{ requests|selectattr('status', 'equalto', 'è¯·æ±‚ä¸­')|list|count }};
    if (pendingCount > 0) {
        setTimeout(() => {
            location.reload();
        }, 300000); // 5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
    }
}

// å¯ç”¨è‡ªåŠ¨åˆ·æ–°
autoRefresh();
</script>
{% endblock %}