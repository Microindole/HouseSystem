{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/house/house_list.css') }}">
<script src="{{ url_for('static', filename='js/common/message-toast.js') }}"></script>
<script src="{{ url_for('static', filename='js/house/show-news.js') }}"></script>
{% endblock %}

{% block title %}æˆ¿æºåˆ—è¡¨{% endblock %}

{% block body %}
<div class="house-list-container">  <!-- æ”¹ä¸ºæ›´å…·ä½“çš„ç±»å -->
    {% if filters.city %}
    <div class="current-location">
        å½“å‰é€‰æ‹©åœ°åŒºï¼š<strong>{{ filters.city}}</strong>
    </div>
    {% endif %}

    <!-- æ–°é—»åŒº -->
    <div class="news-section">
        <div class="news-header">
            <h2>æœ€æ–°èµ„è®¯</h2>
            <div class="news-controls">
                <button id="prev-news" class="nav-btn" disabled>â€¹</button>
                <button id="next-news" class="nav-btn">â€º</button>
            </div>
        </div>

        {% if news_list %}
        <div class="news-container">
            <div class="news-carousel" id="news-carousel">
                <!-- ä¿®æ”¹æ–°é—»é¡¹ï¼Œæ·»åŠ ç‚¹å‡»è·³è½¬é“¾æ¥ -->
                {% for news in news_list %}
                <div class="news-item" data-index="{{ loop.index0 }}">
                    <div class="news-content">
                        <h3 class="news-title">
                            <a href="{{ url_for('house.news_detail', news_id=news.id) }}">{{ news.title }}</a>
                        </h3>
                        <p class="news-desc">{{ news.desc[:100] if news.desc else 'æš‚æ— è¯¦ç»†æè¿°' }}{% if news.desc and news.desc|length > 100 %}...{% endif %}</p>
                        <div class="news-footer">
                            <span class="news-date">{{ news.time.strftime('%mæœˆ%dæ—¥') if news.time else 'æœªçŸ¥æ—¶é—´' }}</span>
                            {% if news.house_info %}
                            <span class="news-house">{{ news.house_info.house_name }}</span>
                            {% endif %}
                            <a href="{{ url_for('house.news_detail', news_id=news.id) }}" class="read-more">é˜…è¯»å…¨æ–‡</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="news-indicators">
            {% for i in range((news_list|length + 2) // 3) %}
            <span class="indicator {% if loop.index0 == 0 %}active{% endif %}" data-slide="{{ loop.index0 }}"></span>
            {% endfor %}
        </div>

        <!-- ä¿®æ”¹æŸ¥çœ‹æ›´å¤šæ–°é—»æŒ‰é’® -->
        <div class="news-footer-section">
            <a href="{{ url_for('house.news_list') }}" class="btn btn-primary" id="view-more-news">æŸ¥çœ‹æ›´å¤šæ–°é—»</a>
            <span class="news-stats">å…± <span id="total-news">{{ news_list|length }}</span> æ¡èµ„è®¯</span>
        </div>
        {% else %}
        <div class="no-news">
            <div class="no-news-icon">ğŸ“°</div>
            <p>æš‚æ— æ–°é—»èµ„è®¯</p>
        </div>
        {% endif %}
    </div>


    <!-- ç­›é€‰è¡¨å• -->
    <form method="get" action="{{ url_for('house.house_list') }}" class="filter-form">
        <input type="hidden" name="region" value="{{ selected_region }}">
        <input type="hidden" name="city" value="{{ selected_city }}">

        <div>
            <label>åœ°å€å…³é”®è¯ï¼š</label>
            <input type="text" name="address" placeholder="ä¾‹å¦‚ï¼šæœé˜³ã€äº”é“å£" value="{{ filters.address or '' }}">
        </div>

        <div>
            <label>æˆ·å‹ï¼š</label>
            <select name="rooms">
                <option value="">ä¸é™</option>
                <option value="1å®¤" {% if filters.rooms == '1å®¤' %}selected{% endif %}>1å®¤</option>
                <option value="2å®¤" {% if filters.rooms == '2å®¤' %}selected{% endif %}>2å®¤</option>
                <option value="3å®¤" {% if filters.rooms == '3å®¤' %}selected{% endif %}>3å®¤</option>
                <option value="4å®¤" {% if filters.rooms == '4å®¤' %}selected{% endif %}>4å®¤</option>
                <option value="4å®¤åŠä»¥ä¸Š" {% if filters.rooms == '4å®¤åŠä»¥ä¸Š' %}selected{% endif %}>4å®¤åŠä»¥ä¸Š</option>
            </select>
        </div>

        <div>
            <label>ä»·æ ¼èŒƒå›´ï¼š</label>
            <div style="display: flex; gap: 8px;">
                <input type="number" name="min_price" placeholder="æœ€ä½ä»·" value="{{ filters.min_price }}" style="flex: 1;">
                <span style="align-self: center; color: #64748b;">-</span>
                <input type="number" name="max_price" placeholder="æœ€é«˜ä»·" value="{{ filters.max_price }}" style="flex: 1;">
            </div>
        </div>

        <button type="submit">ç­›é€‰</button>
    </form>

    <!-- æˆ¿æºåˆ—è¡¨ -->
    <div class="house-list-section">
    <div class="house-list-header">
        <h2>æˆ¿æºåˆ—è¡¨</h2>
     <span class="total-count">å…±æœç´¢åˆ° {{ total_count }} å¥—æˆ¿æº</span></div>
        {% if houses %}
            {% for house in houses %}
            <div class="house-card">
                {% if house.image %}
                    <img src="{{ house.image }}" class="house-image" alt="æˆ¿å±‹å›¾ç‰‡">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default_house_thumbnail.png') }}" class="house-image" alt="æš‚æ— å›¾ç‰‡">
                {% endif %}
                
                <div class="house-info">
                    <h3 class="house-title">{{ house.house_name }}</h3>
                    
                    <div class="house-details">
                        <span><strong>æˆ·å‹ï¼š</strong>{{ house.rooms }}</span>
                        <span><strong>åœ°åŒºï¼š</strong>{{ house.region }}</span>
                        <span><strong>åœ°å€ï¼š</strong>{{ house.addr }}</span>
                    </div>
                    
                    <div class="house-features">
                        {% if house.highlight %}
                        <span class="house-highlight">ğŸŒŸ {{ house.highlight }}</span>
                        {% endif %}
                        {% if house.situation %}
                        <span class="house-situation">ğŸ  è£…ä¿®ï¼š{{ house.situation }}</span>
                        {% endif %}
                    </div>
                    
                    {% if house.deposit %}
                    <div class="house-deposit">ğŸ’° æŠ¼é‡‘ï¼š{{ house.deposit }} å…ƒ</div>
                    {% endif %}
                </div>
                
                <div class="house-price-section">
                    <div class="house-price">
                        <span class="price-amount">{{ house.price }}</span>
                        <span class="price-unit">å…ƒ/æœˆ</span>
                    </div>
                    <a href="{{ url_for('house.house_detail', house_id=house.house_id) }}" class="btn-detail">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="no-houses-message">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æˆ¿æºã€‚</p>
        {% endif %}
    </div>

    <!-- åˆ†é¡µæ§åˆ¶ -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        <ul class="pagination-list">
            {% if pagination.has_prev %}
                <li><a href="{{ url_for('house.house_list', page=1, **filters) }}">é¦–é¡µ</a></li>
                <li><a href="{{ url_for('house.house_list', page=pagination.prev_num, **filters) }}">ä¸Šä¸€é¡µ</a></li>
            {% endif %}
            {% for p in range(1, pagination.pages + 1) %}
                {% if p == pagination.page %}
                    <li class="active"><span>{{ p }}</span></li>
                {% else %}
                    <li><a href="{{ url_for('house.house_list', page=p, **filters) }}">{{ p }}</a></li>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
                <li><a href="{{ url_for('house.house_list', page=pagination.next_num, **filters) }}">ä¸‹ä¸€é¡µ</a></li>
                <li><a href="{{ url_for('house.house_list', page=pagination.pages, **filters) }}">æœ«é¡µ</a></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

