{% extends 'base.html' %}
{% block title %}ç®¡ç†æ–°é—»{% endblock %}
{% block head %}
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-section h1 {
            color: #333;
            margin: 0;
        }

        .btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
        }

        .btn:hover {
            opacity: 0.9;
            text-decoration: none;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .news-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .news-item {
            border-bottom: 1px solid #eee;
            padding: 20px;
            transition: background-color 0.3s;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-item:hover {
            background-color: #f8f9fa;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .news-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
            flex: 1;
        }

        .news-actions {
            display: flex;
            gap: 10px;
        }

        .news-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .news-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .house-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            border-left: 3px solid #007bff;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .stats-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .news-header {
                flex-direction: column;
                gap: 10px;
            }

            .news-actions {
                align-self: flex-start;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
{% endblock %}
{% block body %}
    <div class="container">
        <div class="header-section">
            <h1>ç®¡ç†æ–°é—»</h1>
            <div>
                <a href="{{ url_for('house.add_news') }}" class="btn">å‘å¸ƒæ–°é—»</a>
                <a href="{{ url_for('account.landlord_home') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>

        {% if news_list %}
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number">{{ news_list|length }}</div>
                    <div class="stat-label">æ€»æ–°é—»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ news_list|selectattr('time')|list|length }}</div>
                    <div class="stat-label">å·²å‘å¸ƒ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% set recent_news = news_list|selectattr('time')|list %}
                        {% set week_ago = moment().subtract(7, 'days') if moment is defined else none %}
                        {{ recent_news|length }}
                    </div>
                    <div class="stat-label">æœ¬å‘¨å‘å¸ƒ</div>
                </div>
            </div>

            <div class="news-list">
                {% for news in news_list %}
                    <div class="news-item">
                        <div class="news-header">
                            <h3 class="news-title">{{ news.title }}</h3>
                            <div class="news-actions">
                                <button class="btn btn-danger" onclick="deleteNews({{ news.id }})">åˆ é™¤</button>
                            </div>
                        </div>

                        <div class="news-meta">
                            <span>å‘å¸ƒæ—¶é—´ï¼š{{ news.time.strftime('%Y-%m-%d %H:%M') if news.time else 'æœªçŸ¥' }}</span>
                            <span>æˆ¿æºIDï¼š{{ news.house_id }}</span>
                        </div>

                        {% if news.desc %}
                            <div class="news-content">
                                {{ news.desc }}
                            </div>
                        {% endif %}

                        <div class="house-info">
                            <strong>å…³è”æˆ¿æºï¼š</strong>
                            {% if news.house_info %}
                                {{ news.house_info.house_name }} - {{ news.house_info.region }}
                                <a href="{{ url_for('house.house_detail', house_id=news.house_id) }}"
                                   style="margin-left: 10px; color: #007bff;">æŸ¥çœ‹æˆ¿æº</a>
                            {% else %}
                                æˆ¿æºä¿¡æ¯ä¸å¯ç”¨ï¼ˆæˆ¿æºID: {{ news.house_id }}ï¼‰
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="icon">ğŸ“°</div>
                <h3>æš‚æ— æ–°é—»</h3>
                <p>æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•æ–°é—»</p>
                <a href="{{ url_for('house.add_news') }}" class="btn">å‘å¸ƒç¬¬ä¸€æ¡æ–°é—»</a>
            </div>
        {% endif %}
    </div>
    <script src="{{ url_for('static', filename='js/common/message-toast.js') }}"></script>
    <script>
        async function deleteNews(newsId) { // MODIFIED: Made function async
            let confirmed = false;
            // MODIFIED: Using window.showConfirm
            if (window.showConfirm) {
                confirmed = await window.showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', {
                    title: 'åˆ é™¤ç¡®è®¤',
                    type: 'warning',
                    confirmText: 'ç¡®å®šåˆ é™¤',
                    cancelText: 'å–æ¶ˆ'
                });
            } else {
                confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'); // Fallback
            }

            if (confirmed) {
                fetch(`/house/news/delete/${newsId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // MODIFIED: Using window.showMessage for success
                            if (window.showMessage) {
                                window.showMessage(data.message || 'æ–°é—»åˆ é™¤æˆåŠŸ', 'success');
                            } else {
                                alert(data.message || 'æ–°é—»åˆ é™¤æˆåŠŸ');
                            }
                            location.reload(); // Keeping original behavior
                        } else {
                            // MODIFIED: Using window.showMessage for error
                            if (window.showMessage) {
                                window.showMessage('åˆ é™¤å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            } else {
                                alert('åˆ é™¤å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // MODIFIED: Using window.showMessage for network/fetch error
                        if (window.showMessage) {
                            window.showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                        }
                    });
            }
        }

        // æ‰¹é‡æ“ä½œï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        function selectAllNews() {
            const checkboxes = document.querySelectorAll('.news-checkbox');
            const selectAllBox = document.getElementById('select-all');

            if (!selectAllBox || !checkboxes) return; // Added guard for missing elements

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllBox.checked;
            });

            updateBatchActions();
        }

        function updateBatchActions() {
            const checkedBoxes = document.querySelectorAll('.news-checkbox:checked');
            const batchActions = document.getElementById('batch-actions');

            if (!batchActions) return; // Added guard

            if (checkedBoxes.length > 0) {
                batchActions.style.display = 'block';
            } else {
                batchActions.style.display = 'none';
            }
        }

        async function batchDelete() { // MODIFIED: Made function async
            const checkedBoxes = document.querySelectorAll('.news-checkbox:checked');
            const newsIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (newsIds.length === 0) {
                // MODIFIED: Using window.showMessage
                if (window.showMessage) {
                    window.showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–°é—»', 'warning');
                } else {
                    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–°é—»');
                }
                return;
            }

            let confirmed = false;
            // MODIFIED: Using window.showConfirm
            if (window.showConfirm) {
                confirmed = await window.showConfirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${newsIds.length} æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, {
                    title: 'æ‰¹é‡åˆ é™¤ç¡®è®¤',
                    type: 'warning',
                    confirmText: 'ç¡®å®šåˆ é™¤',
                    cancelText: 'å–æ¶ˆ'
                });
            } else {
                confirmed = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${newsIds.length} æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`); // Fallback
            }

            if (confirmed) {
                fetch('/house/news/batch-delete', { // Assuming this is the correct endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ news_ids: newsIds })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // MODIFIED: Using window.showMessage
                            if (window.showMessage) {
                                window.showMessage(data.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                            } else {
                                alert(data.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ');
                            }
                            location.reload(); // Keeping original behavior
                        } else {
                            // MODIFIED: Using window.showMessage
                            if (window.showMessage) {
                                window.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            } else {
                                alert('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // MODIFIED: Using window.showMessage
                        if (window.showMessage) {
                            window.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                        } else {
                            alert('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                        }
                    });
            }
        }
    </script>
{% endblock %}