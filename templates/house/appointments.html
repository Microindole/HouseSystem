{% extends 'base.html' %}
{% block title %}é¢„çº¦åˆ—è¡¨{% endblock %}
{% block head %}
    <style>
        .appointments-wrapper{max-width:1200px;margin:20px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
        .appointments-header{text-align:center;margin-bottom:30px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .appointments-title{color:#333;font-size:2.2em;font-weight:600;margin:0}
        .appointments-table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
        .appointments-table th{background:linear-gradient(135deg,#3498db,#2980b9);color:white;padding:15px 20px;text-align:center;font-weight:600;font-size:1em;border:none}
        .appointments-table td{padding:15px 20px;text-align:center;border-bottom:1px solid #f5f5f5;vertical-align:middle}
        .appointments-table tr:nth-child(even){background:#f9f9f9}
        .appointments-table tr:hover{background:#f0f8ff;transition:background 0.3s ease}
        .btn-action{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:500;transition:all 0.3s ease;margin:0 3px}
        .btn-success{background:linear-gradient(135deg,#4caf50,#45a049);color:white;border:1px solid #45a049}
        .btn-success:hover{background:linear-gradient(135deg,#45a049,#3d8b40);transform:translateY(-2px);box-shadow:0 4px 12px rgba(76,175,80,0.3)}
        .btn-danger{background:linear-gradient(135deg,#f44336,#d32f2f);color:white;border:1px solid #d32f2f}
        .btn-danger:hover{background:linear-gradient(135deg,#d32f2f,#b71c1c);transform:translateY(-2px);box-shadow:0 4px 12px rgba(244,67,54,0.3)}
        .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:0.9em;font-weight:600;text-align:center;min-width:80px}
        .status-pending{background:#ffa726;color:white}
        .status-approved{background:#4caf50;color:white}
        .status-rejected{background:#f44336;color:white}
        .processed-label{color:#666;font-style:italic}
        .empty-state{text-align:center;padding:60px 20px;color:#666}
        .empty-state i{font-size:4em;color:#ddd;margin-bottom:20px}
        .btn-action:disabled{opacity:0.6;cursor:not-allowed}
        @media (max-width:768px){
            .appointments-wrapper{margin:10px;padding:20px}
            .appointments-title{font-size:1.8em}
            .appointments-table th,.appointments-table td{padding:10px 8px;font-size:0.9em}
            .btn-action{padding:6px 12px;font-size:0.85em}
        }
    </style>
{% endblock %}

{% block body %}
    <div class="appointments-wrapper">
        <div class="appointments-header">
            <h1 class="appointments-title">é¢„çº¦åˆ—è¡¨</h1>
        </div>

        {% if appointments %}
            <table class="appointments-table">
                <thead>
                    <tr>
                        <th>æˆ¿å±‹åç§°</th>
                        <th>ç§Ÿå®¢</th>
                        <th>é¢„çº¦æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        {% if g.user_type == 2 %}
                        <th>æ“ä½œ</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in appointments %}
                    <tr data-appointment-id="{{ appointment.appointment_id }}">
                        <td>{{ appointment.house_name }}</td>
                        <td>{{ appointment.tenant_name }}</td>
                        <td>{{ appointment.appointment_time }}</td>
                        <td class="status-cell">
                            <span class="status-badge {% if appointment.status == 'ç”³è¯·ä¸­' %}status-pending{% elif appointment.status == 'å·²åŒæ„' %}status-approved{% elif appointment.status == 'å·²æ‹’ç»' %}status-rejected{% endif %}">
                                {{ appointment.status }}
                            </span>
                        </td>
                        {% if g.user_type == 2 %}
                        <td class="action-cell">
                            {% if appointment.status == 'ç”³è¯·ä¸­' %}
                                <button class="btn-action btn-success" onclick="updateStatus({{ appointment.appointment_id }}, 'å·²åŒæ„', this)">åŒæ„</button>
                                <button class="btn-action btn-danger" onclick="updateStatus({{ appointment.appointment_id }}, 'å·²æ‹’ç»', this)">æ‹’ç»</button>
                            {% else %}
                                <span class="processed-label">å·²å¤„ç†</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <i>ğŸ“…</i>
                <h3>æš‚æ— é¢„çº¦è®°å½•</h3>
                <p>å½“å‰æ²¡æœ‰ä»»ä½•é¢„çº¦ä¿¡æ¯</p>
            </div>
        {% endif %}
    </div>

    <script src="{{ url_for('static', filename='js/common/message-toast.js') }}"></script>
    <script>
        function updateStatus(appointmentId, status, buttonElement) {
            // è·å–å½“å‰è¡Œçš„å…ƒç´ 
            const row = buttonElement.closest('tr');
            const statusCell = row.querySelector('.status-cell .status-badge');
            const actionCell = row.querySelector('.action-cell');
            const allButtons = actionCell.querySelectorAll('.btn-action');
            
            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            const originalText = buttonElement.textContent;
            buttonElement.textContent = status === 'å·²åŒæ„' ? 'å¤„ç†ä¸­...' : 'å¤„ç†ä¸­...';
            
            fetch(`/house/appointment/${appointmentId}/update`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (window.showMessage) {
                        window.showMessage(data.msg || 'æ“ä½œæˆåŠŸ', 'success');
                    } else {
                        alert(data.msg || 'æ“ä½œæˆåŠŸ');
                    }
                    
                    // å¼‚æ­¥æ›´æ–°UI - æ›´æ–°çŠ¶æ€å¾½ç« 
                    statusCell.textContent = status;
                    statusCell.className = 'status-badge ' + (status === 'å·²åŒæ„' ? 'status-approved' : 'status-rejected');
                    
                    // æ›´æ–°æ“ä½œåˆ— - æ›¿æ¢æŒ‰é’®ä¸ºå·²å¤„ç†çŠ¶æ€
                    actionCell.innerHTML = '<span class="processed-label">å·²å¤„ç†</span>';
                    
                    // æ·»åŠ æ›´æ–°åŠ¨ç”»æ•ˆæœ
                    statusCell.style.transform = 'scale(1.1)';
                    statusCell.style.transition = 'transform 0.3s ease';
                    setTimeout(() => {
                        statusCell.style.transform = 'scale(1)';
                    }, 300);
                    
                } else {
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    if (window.showMessage) {
                        window.showMessage(data.msg || 'æ“ä½œå¤±è´¥', 'error');
                    } else {
                        alert(data.msg || 'æ“ä½œå¤±è´¥');
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    allButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    buttonElement.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                if (window.showMessage) {
                    window.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                } else {
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                buttonElement.textContent = originalText;
            });
        }
    </script>
{% endblock %}